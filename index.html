<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billiard Pro - Smart Table & Match Timer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #080c14; color: white; }
        .font-digital { font-family: 'Orbitron', sans-serif; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        .active-table { border-top: 4px solid #eab308; box-shadow: 0 10px 30px -10px rgba(234, 179, 8, 0.2); }
    </style>
</head>
<body class="p-4 lg:p-6">

    <div class="max-w-7xl mx-auto space-y-6">
        <div class="flex justify-between items-center glass p-4 rounded-2xl">
            <h1 class="text-xl font-black font-digital text-yellow-500 tracking-tighter text-center sm:text-left">üé± PRO BILLIARD <span class="text-white text-[10px] block sm:inline font-sans font-normal opacity-50 uppercase tracking-widest">Smart Match System</span></h1>
            <button onclick="clearAll()" class="text-[10px] bg-red-950/30 text-red-500 border border-red-500/30 px-4 py-2 rounded-full font-bold uppercase hover:bg-red-500 hover:text-white transition">Reset Data</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-3 space-y-4">
                <div class="glass p-5 rounded-2xl">
                    <h3 class="text-[10px] font-black text-yellow-500 uppercase mb-4 tracking-widest">Daftarkan Pemain</h3>
                    <input type="text" id="pName" placeholder="Nama Pemain..." class="w-full p-3 bg-slate-900 border border-slate-800 rounded-xl mb-3 outline-none focus:border-yellow-500 transition">
                    <select id="pGrade" class="w-full p-3 bg-slate-900 border border-slate-800 rounded-xl mb-4 text-yellow-500 font-bold uppercase">
                        <option>Grade 4</option><option>Grade 5</option><option>Grade 6</option><option>Grade 7</option>
                    </select>
                    <button onclick="addPlayer()" class="w-full bg-yellow-500 text-black font-black py-3 rounded-xl hover:bg-yellow-400 transition shadow-lg shadow-yellow-500/20">TAMBAHKAN</button>
                </div>
                
                <button onclick="smartRandomize()" class="w-full bg-indigo-600 hover:bg-indigo-500 py-4 rounded-2xl font-black shadow-xl flex flex-col items-center justify-center gap-1 transition active:scale-95">
                    <span class="text-lg">üé≤ ACAK MEJA</span>
                    <span class="text-[9px] opacity-70 uppercase tracking-widest font-sans">Isi Meja Kosong</span>
                </button>
                
                <div id="playerList" class="space-y-2 max-h-60 overflow-y-auto pr-2"></div>
            </div>

            <div class="lg:col-span-9 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div id="card_t1" class="glass p-6 rounded-[2rem] transition-all duration-500">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-[10px] font-black bg-slate-800 px-3 py-1 rounded-full text-slate-400 uppercase tracking-widest">Table 01</span>
                            <div id="t1_timer_display" class="text-xs font-digital text-yellow-500 font-bold">00:00:00</div>
                        </div>
                        <div class="flex justify-between items-center text-center gap-4 mb-8">
                            <div class="flex-1">
                                <p id="t1_p1" class="text-[10px] font-black text-blue-400 uppercase truncate">Player 1</p>
                                <div id="t1_s1" class="text-6xl font-digital my-2 text-white">0</div>
                                <button onclick="upScore('t1_s1')" class="w-full bg-blue-600/10 text-blue-500 border border-blue-600/30 py-1.5 rounded-lg text-[10px] font-black hover:bg-blue-600 hover:text-white">+ FRAME</button>
                            </div>
                            <div class="text-slate-800 font-black italic text-xl">VS</div>
                            <div class="flex-1">
                                <p id="t1_p2" class="text-[10px] font-black text-red-400 uppercase truncate">Player 2</p>
                                <div id="t1_s2" class="text-6xl font-digital my-2 text-white">0</div>
                                <button onclick="upScore('t1_s2')" class="w-full bg-red-600/10 text-red-500 border border-red-600/30 py-1.5 rounded-lg text-[10px] font-black hover:bg-red-600 hover:text-white">+ FRAME</button>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button id="t1_btn_start" onclick="toggleTimer(1)" class="flex-1 bg-white/5 border border-white/10 py-3 rounded-xl font-black text-[10px] uppercase hover:bg-white/10">Mulai Waktu</button>
                            <button onclick="saveMatch(1)" class="flex-[2] bg-emerald-600 py-3 rounded-xl font-black text-[10px] uppercase shadow-lg shadow-emerald-900/20">Simpan Hasil</button>
                        </div>
                    </div>

                    <div id="card_t2" class="glass p-6 rounded-[2rem] transition-all duration-500">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-[10px] font-black bg-slate-800 px-3 py-1 rounded-full text-slate-400 uppercase tracking-widest">Table 02</span>
                            <div id="t2_timer_display" class="text-xs font-digital text-yellow-500 font-bold">00:00:00</div>
                        </div>
                        <div class="flex justify-between items-center text-center gap-4 mb-8">
                            <div class="flex-1">
                                <p id="t2_p1" class="text-[10px] font-black text-blue-400 uppercase truncate">Player 1</p>
                                <div id="t2_s1" class="text-6xl font-digital my-2 text-white">0</div>
                                <button onclick="upScore('t2_s1')" class="w-full bg-blue-600/10 text-blue-500 border border-blue-600/30 py-1.5 rounded-lg text-[10px] font-black hover:bg-blue-600 hover:text-white">+ FRAME</button>
                            </div>
                            <div class="text-slate-800 font-black italic text-xl">VS</div>
                            <div class="flex-1">
                                <p id="t2_p2" class="text-[10px] font-black text-red-400 uppercase truncate">Player 2</p>
                                <div id="t2_s2" class="text-6xl font-digital my-2 text-white">0</div>
                                <button onclick="upScore('t2_s2')" class="w-full bg-red-600/10 text-red-500 border border-red-600/30 py-1.5 rounded-lg text-[10px] font-black hover:bg-red-600 hover:text-white">+ FRAME</button>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button id="t2_btn_start" onclick="toggleTimer(2)" class="flex-1 bg-white/5 border border-white/10 py-3 rounded-xl font-black text-[10px] uppercase hover:bg-white/10">Mulai Waktu</button>
                            <button onclick="saveMatch(2)" class="flex-[2] bg-emerald-600 py-3 rounded-xl font-black text-[10px] uppercase shadow-lg shadow-emerald-900/20">Simpan Hasil</button>
                        </div>
                    </div>
                </div>

                <div class="glass rounded-3xl overflow-hidden shadow-2xl">
                    <div class="p-4 bg-white/5 border-b border-white/5 font-black text-yellow-500 text-[10px] tracking-widest uppercase">Klasemen Sementara</div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-xs">
                            <thead class="bg-black/30 text-slate-500 uppercase text-[9px]">
                                <tr><th class="p-4">Rank</th><th class="p-4">Nama</th><th class="p-4 text-center">W</th><th class="p-4 text-center text-yellow-500">Poin</th></tr>
                            </thead>
                            <tbody id="rankTable" class="divide-y divide-white/5"></tbody>
                        </table>
                    </div>
                </div>

                <div class="glass rounded-3xl overflow-hidden shadow-2xl">
                    <div class="p-4 bg-white/5 border-b border-white/5 font-black text-blue-400 text-[10px] tracking-widest uppercase flex justify-between">
                        <span>Riwayat Pertandingan</span>
                        <span class="text-[9px] opacity-50 font-sans tracking-normal font-normal uppercase">Lama Main Teratat</span>
                    </div>
                    <div id="historyList" class="p-4 space-y-3 max-h-60 overflow-y-auto text-[10px]"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let db_players = JSON.parse(localStorage.getItem('bill_smart_p')) || [];
        let db_history = JSON.parse(localStorage.getItem('bill_smart_h')) || [];
        
        let timers = { 1: null, 2: null };
        let timerSeconds = { 1: 0, 2: 0 };
        let currentPairs = { 1: [], 2: [] };

        function saveDB() {
            localStorage.setItem('bill_smart_p', JSON.stringify(db_players));
            localStorage.setItem('bill_smart_h', JSON.stringify(db_history));
            renderAll();
        }

        function addPlayer() {
            const name = document.getElementById('pName').value.trim().toUpperCase();
            const grade = document.getElementById('pGrade').value;
            if(!name || db_players.find(p => p.name === name)) return;
            db_players.push({ name, grade, w: 0, pts: 0 });
            document.getElementById('pName').value = "";
            saveDB();
        }

        function upScore(id) {
            const el = document.getElementById(id);
            el.innerText = parseInt(el.innerText) + 1;
        }

        function smartRandomize() {
            const t1_occupied = document.getElementById('t1_p1').innerText !== "PLAYER 1";
            const t2_occupied = document.getElementById('t2_p1').innerText !== "PLAYER 2";

            if (t1_occupied && t2_occupied) return alert("Kedua meja sedang penuh!");

            let busyPlayers = [];
            if(t1_occupied) busyPlayers.push(document.getElementById('t1_p1').innerText, document.getElementById('t1_p2').innerText);
            if(t2_occupied) busyPlayers.push(document.getElementById('t2_p1').innerText, document.getElementById('t2_p2').innerText);

            let pairs = [];
            for(let i=0; i<db_players.length; i++) {
                for(let j=i+1; j<db_players.length; j++) {
                    const n1 = db_players[i].name;
                    const n2 = db_players[j].name;
                    if(busyPlayers.includes(n1) || busyPlayers.includes(n2)) continue;
                    
                    const played = db_history.some(h => (h.p1===n1 && h.p2===n2) || (h.p1===n2 && h.p2===n1));
                    if(!played) pairs.push([db_players[i], db_players[j]]);
                }
            }

            if(pairs.length === 0) return alert("Tidak ada pasangan pemain tersedia yang belum pernah bertanding!");
            pairs.sort(() => Math.random() - 0.5);

            // Jika keduanya kosong, panggil 4 orang (2 pasang)
            if(!t1_occupied && !t2_occupied) {
                setTable(1, pairs[0]);
                if(pairs.length > 1) {
                    // Pastikan pemain di meja 2 beda dengan meja 1
                    const used = [pairs[0][0].name, pairs[0][1].name];
                    const secondPair = pairs.find(p => !used.includes(p[0].name) && !used.includes(p[1].name));
                    if(secondPair) setTable(2, secondPair);
                }
            } else if(!t1_occupied) {
                setTable(1, pairs[0]);
            } else if(!t2_occupied) {
                setTable(2, pairs[0]);
            }
        }

        function setTable(table, pair) {
            document.getElementById(`t${table}_p1`).innerText = pair[0].name;
            document.getElementById(`t${table}_p2`).innerText = pair[1].name;
            document.getElementById(`card_t${table}`).classList.add('active-table');
        }

        function toggleTimer(table) {
            if(timers[table]) {
                clearInterval(timers[table]);
                timers[table] = null;
                document.getElementById(`t${table}_btn_start`).innerText = "Lanjut";
                document.getElementById(`t${table}_btn_start`).classList.remove('bg-emerald-600/20');
            } else {
                if(document.getElementById(`t${table}_p1`).innerText === "PLAYER 1") return alert("Isi pemain dulu!");
                document.getElementById(`t${table}_btn_start`).innerText = "Berhenti";
                document.getElementById(`t${table}_btn_start`).classList.add('bg-emerald-600/20');
                timers[table] = setInterval(() => {
                    timerSeconds[table]++;
                    document.getElementById(`t${table}_timer_display`).innerText = formatTime(timerSeconds[table]);
                }, 1000);
            }
        }

        function formatTime(sec) {
            let h = Math.floor(sec / 3600);
            let m = Math.floor((sec % 3600) / 60);
            let s = sec % 60;
            return [h, m, s].map(v => v < 10 ? "0" + v : v).join(":");
        }

        function saveMatch(table) {
            const p1Name = document.getElementById(`t${table}_p1`).innerText;
            const p2Name = document.getElementById(`t${table}_p2`).innerText;
            const s1 = parseInt(document.getElementById(`t${table}_s1`).innerText);
            const s2 = parseInt(document.getElementById(`t${table}_s2`).innerText);
            const dur = document.getElementById(`t${table}_timer_display`).innerText;

            if(p1Name === "PLAYER 1" || s1 === s2) return alert("Validasi Gagal: Cek Pemain & Skor!");
            if(timerSeconds[table] === 0) return alert("Mulai waktu terlebih dahulu!");

            let p1 = db_players.find(p => p.name === p1Name);
            let p2 = db_players.find(p => p.name === p2Name);

            if(s1 > s2) { p1.w++; p1.pts += 3; } else { p2.w++; p2.pts += 3; }

            db_history.unshift({ p1: p1Name, p2: p2Name, s1, s2, duration: dur, time: new Date().toLocaleTimeString() });

            // Cleanup Meja
            clearInterval(timers[table]);
            timers[table] = null;
            timerSeconds[table] = 0;
            document.getElementById(`t${table}_p1`).innerText = "PLAYER " + table;
            document.getElementById(`t${table}_p2`).innerText = "PLAYER " + table;
            document.getElementById(`t${table}_s1`).innerText = "0";
            document.getElementById(`t${table}_s2`).innerText = "0";
            document.getElementById(`t${table}_timer_display`).innerText = "00:00:00";
            document.getElementById(`t${table}_btn_start`).innerText = "Mulai Waktu";
            document.getElementById(`card_t${table}`).classList.remove('active-table');

            saveDB();
        }

        function renderAll() {
            document.getElementById('playerList').innerHTML = db_players.map(p => `
                <div class="bg-slate-900 p-3 rounded-xl border border-white/5 text-[10px] flex justify-between shadow-inner">
                    <span class="font-bold uppercase tracking-tighter">${p.name} <span class="opacity-40 ml-1">(${p.grade})</span></span>
                    <span class="text-yellow-500 font-bold font-digital">${p.pts} Pts</span>
                </div>
            `).join('');

            const sorted = [...db_players].sort((a,b) => b.pts - a.pts || b.w - a.w);
            document.getElementById('rankTable').innerHTML = sorted.map((p,i) => `
                <tr class="hover:bg-white/5 transition">
                    <td class="p-4 font-digital text-yellow-500 font-bold">${i+1}</td>
                    <td class="p-4 font-black uppercase">${p.name} <span class="text-[8px] opacity-40 ml-1 font-sans">${p.grade}</span></td>
                    <td class="p-4 text-center">${p.w}</td>
                    <td class="p-4 text-center font-digital font-bold text-yellow-500">${p.pts}</td>
                </tr>
            `).join('');

            document.getElementById('historyList').innerHTML = db_history.map(h => `
                <div class="bg-black/40 p-3 rounded-xl border-l-2 border-indigo-500 flex justify-between items-center group">
                    <div class="flex flex-col gap-1">
                        <span class="font-bold tracking-tight uppercase">${h.p1} <span class="text-yellow-500 mx-1 font-digital">${h.s1}-${h.s2}</span> ${h.p2}</span>
                        <div class="flex items-center gap-2 opacity-40">
                             <span class="bg-slate-800 px-2 py-0.5 rounded text-[8px]">‚è≥ ${h.duration}</span>
                             <span class="text-[8px]">${h.time}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function clearAll() {
            if(confirm("Hapus seluruh data pemain dan riwayat?")) {
                localStorage.clear();
                location.reload();
            }
        }

        renderAll();
    </script>
</body>
</html>
