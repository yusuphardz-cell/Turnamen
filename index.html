<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billiard Pro - Individual Table Shuffle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #080c14; color: white; }
        .font-digital { font-family: 'Orbitron', sans-serif; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        .active-table { border-top: 4px solid #eab308; box-shadow: 0 10px 30px -10px rgba(234, 179, 8, 0.2); }
        #share-area { background: #080c14; border-radius: 20px; }
    </style>
</head>
<body class="p-4 lg:p-6 text-slate-200">

    <div class="max-w-7xl mx-auto space-y-6">
        <div class="flex justify-between items-center glass p-4 rounded-2xl border border-white/5">
            <h1 class="text-xl font-black font-digital text-yellow-500 tracking-tighter">üé± PRO BILLIARD</h1>
            <button onclick="clearAll()" class="text-[10px] bg-rose-950/30 text-rose-500 border border-rose-500/30 px-4 py-2 rounded-full font-bold uppercase hover:bg-rose-500 hover:text-white transition">Reset Data</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-3 space-y-4">
                <div class="glass p-5 rounded-2xl">
                    <h3 class="text-[10px] font-black text-yellow-500 uppercase mb-4 tracking-widest">Registrasi Pemain</h3>
                    <input type="text" id="pName" placeholder="Nama Pemain..." class="w-full p-3 bg-slate-900 border border-slate-800 rounded-xl mb-3 outline-none focus:border-yellow-500">
                    <select id="pGrade" class="w-full p-3 bg-slate-900 border border-slate-800 rounded-xl mb-4 text-yellow-500 font-bold uppercase">
                        <option>Grade 4</option><option>Grade 5</option><option>Grade 6</option><option>Grade 7</option>
                    </select>
                    <button onclick="addPlayer()" class="w-full bg-yellow-500 text-black font-black py-3 rounded-xl hover:bg-yellow-400 shadow-lg shadow-yellow-500/20">TAMBAHKAN</button>
                </div>
                
                <div class="grid grid-cols-1 gap-3">
                    <button onclick="shuffleByTable(1)" class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-2xl font-black shadow-xl flex flex-col items-center justify-center transition active:scale-95">
                        <span class="text-sm">üé≤ ACAK MEJA 1</span>
                        <span class="text-[8px] opacity-70 uppercase tracking-widest">Cari Lawan Baru</span>
                    </button>
                    <button onclick="shuffleByTable(2)" class="w-full bg-rose-600 hover:bg-rose-500 py-4 rounded-2xl font-black shadow-xl flex flex-col items-center justify-center transition active:scale-95">
                        <span class="text-sm">üé≤ ACAK MEJA 2</span>
                        <span class="text-[8px] opacity-70 uppercase tracking-widest">Cari Lawan Baru</span>
                    </button>
                </div>
                
                <div id="playerList" class="space-y-2 max-h-40 overflow-y-auto pr-2"></div>
            </div>

            <div class="lg:col-span-9 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div id="card_t1" class="glass p-6 rounded-[2rem] transition-all duration-500 border border-white/5">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-[10px] font-black bg-blue-600/20 text-blue-400 px-3 py-1 rounded-full uppercase tracking-widest">Table 01</span>
                            <div id="t1_timer_display" class="text-xs font-digital text-yellow-500 font-bold">00:00:00</div>
                        </div>
                        <div class="flex justify-between items-center text-center gap-4 mb-8">
                            <div class="flex-1">
                                <p id="t1_p1" class="text-[10px] font-black text-blue-400 uppercase truncate">Player 1</p>
                                <div id="t1_s1" class="text-6xl font-digital my-2 text-white">0</div>
                                <button onclick="upScore('t1_s1')" class="w-full bg-blue-600/10 text-blue-500 border border-blue-600/30 py-1.5 rounded-lg text-[10px] font-black">+ FRAME</button>
                            </div>
                            <div class="text-slate-800 font-black italic text-xl">VS</div>
                            <div class="flex-1">
                                <p id="t1_p2" class="text-[10px] font-black text-red-400 uppercase truncate">Player 2</p>
                                <div id="t1_s2" class="text-6xl font-digital my-2 text-white">0</div>
                                <button onclick="upScore('t1_s2')" class="w-full bg-red-600/10 text-red-500 border border-red-600/30 py-1.5 rounded-lg text-[10px] font-black">+ FRAME</button>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button id="t1_btn_start" onclick="toggleTimer(1)" class="flex-1 bg-white/5 border border-white/10 py-3 rounded-xl font-black text-[10px] uppercase">Mulai</button>
                            <button onclick="saveMatch(1)" class="flex-[2] bg-emerald-600 py-3 rounded-xl font-black text-[10px] uppercase">Simpan</button>
                        </div>
                    </div>

                    <div id="card_t2" class="glass p-6 rounded-[2rem] transition-all duration-500 border border-white/5">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-[10px] font-black bg-rose-600/20 text-rose-400 px-3 py-1 rounded-full uppercase tracking-widest">Table 02</span>
                            <div id="t2_timer_display" class="text-xs font-digital text-yellow-500 font-bold">00:00:00</div>
                        </div>
                        <div class="flex justify-between items-center text-center gap-4 mb-8">
                            <div class="flex-1">
                                <p id="t2_p1" class="text-[10px] font-black text-blue-400 uppercase truncate">Player 1</p>
                                <div id="t2_s1" class="text-6xl font-digital my-2 text-white">0</div>
                                <button onclick="upScore('t2_s1')" class="w-full bg-blue-600/10 text-blue-500 border border-blue-600/30 py-1.5 rounded-lg text-[10px] font-black">+ FRAME</button>
                            </div>
                            <div class="text-slate-800 font-black italic text-xl">VS</div>
                            <div class="flex-1">
                                <p id="t2_p2" class="text-[10px] font-black text-red-400 uppercase truncate">Player 2</p>
                                <div id="t2_s2" class="text-6xl font-digital my-2 text-white">0</div>
                                <button onclick="upScore('t2_s2')" class="w-full bg-red-600/10 text-red-500 border border-red-600/30 py-1.5 rounded-lg text-[10px] font-black">+ FRAME</button>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button id="t2_btn_start" onclick="toggleTimer(2)" class="flex-1 bg-white/5 border border-white/10 py-3 rounded-xl font-black text-[10px] uppercase">Mulai</button>
                            <button onclick="saveMatch(2)" class="flex-[2] bg-emerald-600 py-3 rounded-xl font-black text-[10px] uppercase">Simpan</button>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="flex justify-between items-center px-2">
                        <h2 class="text-xs font-black text-yellow-500 uppercase tracking-widest">üèÜ Klasemen Ranking</h2>
                        <button onclick="downloadKlasemen()" class="bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded-xl text-[10px] font-black flex items-center gap-2 shadow-lg transition active:scale-95">
                            üì∏ SHARE JPG
                        </button>
                    </div>

                    <div id="share-area" class="p-6 border border-white/10 shadow-2xl">
                        <div class="flex items-center gap-3 mb-6 border-b border-white/10 pb-4">
                            <span class="text-2xl">üé±</span>
                            <div>
                                <h1 class="text-lg font-black font-digital text-yellow-500 leading-none">BILLIARD CHAMPIONSHIP</h1>
                                <p class="text-[8px] uppercase tracking-[0.3em] text-slate-500">Official Leaderboard - Live Results</p>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-xs">
                                <thead class="bg-white/5 text-slate-500 uppercase text-[9px]">
                                    <tr><th class="p-4">Rank</th><th class="p-4">Nama Peserta</th><th class="p-4 text-center">W</th><th class="p-4 text-center text-yellow-500">Poin</th></tr>
                                </thead>
                                <tbody id="rankTable" class="divide-y divide-white/5"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="glass rounded-3xl overflow-hidden border border-white/5">
                    <div class="p-4 bg-white/5 border-b border-white/5 font-black text-blue-400 text-[10px] tracking-widest uppercase">Riwayat Pertandingan</div>
                    <div id="historyList" class="p-4 space-y-3 max-h-60 overflow-y-auto text-[10px]"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let db_players = JSON.parse(localStorage.getItem('bill_final_p')) || [];
        let db_history = JSON.parse(localStorage.getItem('bill_final_h')) || [];
        let timers = { 1: null, 2: null };
        let timerSeconds = { 1: 0, 2: 0 };

        function saveDB() {
            localStorage.setItem('bill_final_p', JSON.stringify(db_players));
            localStorage.setItem('bill_final_h', JSON.stringify(db_history));
            renderAll();
        }

        function addPlayer() {
            const name = document.getElementById('pName').value.trim().toUpperCase();
            const grade = document.getElementById('pGrade').value;
            if(!name || db_players.find(p => p.name === name)) return;
            db_players.push({ name, grade, w: 0, pts: 0 });
            document.getElementById('pName').value = "";
            saveDB();
        }

        function upScore(id) {
            const el = document.getElementById(id);
            el.innerText = parseInt(el.innerText) + 1;
        }

        // FUNGSI ACAK PER MEJA (MODIFIKASI UTAMA)
        function shuffleByTable(targetTable) {
            const p1Text = document.getElementById(`t${targetTable}_p1`).innerText;
            if(!p1Text.includes("PLAYER") && timerSeconds[targetTable] > 0) {
                return alert(`Meja ${targetTable} sedang bertanding! Simpan dulu hasil sebelumnya.`);
            }

            // Cek siapa saja yang sedang main di meja SEBELAH agar tidak terpilih
            let otherTable = targetTable === 1 ? 2 : 1;
            let busyPlayers = [];
            const otherP1 = document.getElementById(`t${otherTable}_p1`).innerText;
            const otherP2 = document.getElementById(`t${otherTable}_p2`).innerText;
            
            if(!otherP1.includes("PLAYER")) busyPlayers.push(otherP1, otherP2);

            // Filter pasangan yang belum pernah tanding
            let pairs = [];
            for(let i=0; i<db_players.length; i++) {
                for(let j=i+1; j<db_players.length; j++) {
                    const n1 = db_players[i].name;
                    const n2 = db_players[j].name;
                    
                    if(busyPlayers.includes(n1) || busyPlayers.includes(n2)) continue;
                    
                    const played = db_history.some(h => (h.p1===n1 && h.p2===n2) || (h.p1===n2 && h.p2===n1));
                    if(!played) pairs.push([db_players[i], db_players[j]]);
                }
            }

            if(pairs.length === 0) return alert("Tidak ada lawan baru tersedia untuk meja ini!");
            
            pairs.sort(() => Math.random() - 0.5);
            const chosen = pairs[0];

            document.getElementById(`t${targetTable}_p1`).innerText = chosen[0].name;
            document.getElementById(`t${targetTable}_p2`).innerText = chosen[1].name;
            document.getElementById(`card_t${targetTable}`).classList.add('active-table');
            
            // Reset skor dan waktu meja tersebut saat acak baru
            document.getElementById(`t${targetTable}_s1`).innerText = "0";
            document.getElementById(`t${targetTable}_s2`).innerText = "0";
            timerSeconds[targetTable] = 0;
            document.getElementById(`t${targetTable}_timer_display`).innerText = "00:00:00";
        }

        function toggleTimer(table) {
            if(timers[table]) {
                clearInterval(timers[table]); timers[table] = null;
                document.getElementById(`t${table}_btn_start`).innerText = "Lanjut";
            } else {
                if(document.getElementById(`t${table}_p1`).innerText.includes("PLAYER")) return alert("Acak pemain dulu!");
                document.getElementById(`t${table}_btn_start`).innerText = "Stop";
                timers[table] = setInterval(() => {
                    timerSeconds[table]++;
                    document.getElementById(`t${table}_timer_display`).innerText = formatTime(timerSeconds[table]);
                }, 1000);
            }
        }

        function formatTime(sec) {
            let h = Math.floor(sec / 3600), m = Math.floor((sec % 3600) / 60), s = sec % 60;
            return [h, m, s].map(v => v < 10 ? "0" + v : v).join(":");
        }

        function saveMatch(table) {
            const p1Name = document.getElementById(`t${table}_p1`).innerText;
            const p2Name = document.getElementById(`t${table}_p2`).innerText;
            const s1 = parseInt(document.getElementById(`t${table}_s1`).innerText);
            const s2 = parseInt(document.getElementById(`t${table}_s2`).innerText);
            if(p1Name.includes("PLAYER") || s1 === s2) return alert("Skor seri atau meja kosong!");
            
            let p1 = db_players.find(p => p.name === p1Name), p2 = db_players.find(p => p.name === p2Name);
            if(s1 > s2) { p1.w++; p1.pts += 3; } else { p2.w++; p2.pts += 3; }
            
            db_history.unshift({ p1: p1Name, p2: p2Name, s1, s2, duration: document.getElementById(`t${table}_timer_display`).innerText, time: new Date().toLocaleTimeString() });
            
            clearInterval(timers[table]); timers[table] = null; timerSeconds[table] = 0;
            document.getElementById(`t${table}_p1`).innerText = "PLAYER " + table;
            document.getElementById(`t${table}_p2`).innerText = "PLAYER " + table;
            document.getElementById(`t${table}_s1`).innerText = "0"; document.getElementById(`t${table}_s2`).innerText = "0";
            document.getElementById(`t${table}_timer_display`).innerText = "00:00:00";
            document.getElementById(`t${table}_btn_start`).innerText = "Mulai";
            document.getElementById(`card_t${table}`).classList.remove('active-table');
            saveDB();
        }

        function downloadKlasemen() {
            const area = document.getElementById('share-area');
            html2canvas(area, { backgroundColor: "#080c14", scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'Klasemen_Billiard_Official.jpg';
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();
            });
        }

        function renderAll() {
            document.getElementById('playerList').innerHTML = db_players.map(p => `
                <div class="bg-slate-900 p-2 rounded-lg border border-white/5 text-[10px] flex justify-between shadow-inner">
                    <span class="font-bold uppercase tracking-tight text-slate-300">${p.name}</span>
                    <span class="text-yellow-500 font-bold font-digital">${p.pts} Pts</span>
                </div>
            `).join('');

            const sorted = [...db_players].sort((a,b) => b.pts - a.pts || b.w - a.w);
            document.getElementById('rankTable').innerHTML = sorted.map((p,i) => `
                <tr class="hover:bg-white/5 transition border-b border-white/5">
                    <td class="p-4 font-digital text-yellow-500 font-bold">${i+1}</td>
                    <td class="p-4 font-black uppercase text-white">${p.name} <span class="text-[8px] opacity-40 font-sans ml-1 text-slate-400">(${p.grade})</span></td>
                    <td class="p-4 text-center font-bold text-emerald-400">${p.w}</td>
                    <td class="p-4 text-center font-digital font-bold text-yellow-500 text-lg">${p.pts}</td>
                </tr>
            `).join('');

            document.getElementById('historyList').innerHTML = db_history.map(h => `
                <div class="bg-black/40 p-3 rounded-xl border-l-2 border-indigo-500 flex justify-between items-center group">
                    <div class="flex flex-col gap-1 uppercase">
                        <span class="font-bold text-slate-200">${h.p1} <span class="text-yellow-500 mx-1 font-digital">${h.s1}-${h.s2}</span> ${h.p2}</span>
                        <span class="text-[8px] opacity-40 text-slate-400 tracking-widest font-sans">‚è≥ ${h.duration} | ${h.time}</span>
                    </div>
                </div>
            `).join('');
        }

        function clearAll() { if(confirm("Hapus seluruh data?")) { localStorage.clear(); location.reload(); } }
        renderAll();
    </script>
</body>
</html>
